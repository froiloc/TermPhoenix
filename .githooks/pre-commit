#!/bin/bash

# TermPhoenix Git Pre-commit Hook
# Runs quick checks before each commit

set -e

echo "🔍 TermPhoenix pre-commit checks..."

# Colors
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

print_status() { echo -e "${YELLOW}[PRE-COMMIT]${NC} $1"; }
print_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }

# Check if we're in a TermPhoenix project
if [ ! -f "pyproject.toml" ] || ! grep -q "termphoenix" "pyproject.toml" 2>/dev/null; then
    exit 0
fi

# Check for large files
print_status "Checking for large files..."
MAX_FILE_SIZE=10485760  # 10MB
LARGE_FILES=$(find . -type f -size +${MAX_FILE_SIZE}c -not -path "./venv/*" -not -path "./.git/*" -not -path "./projects/*")

if [ -n "$LARGE_FILES" ]; then
    echo "The following files are larger than 10MB:"
    echo "$LARGE_FILES"
    echo "Consider adding them to .gitignore or using git LFS."
    exit 1
fi

# Check for sensitive data
print_status "Checking for potential secrets..."
if git diff --cached --name-only | xargs grep -l "password\|secret\|key" 2>/dev/null; then
    echo "Warning: Potential secrets found in staged files. Please review."
    # Don't exit 1 here, just warn
fi

# Auto-format Python files
print_status "Auto-formatting Python files..."
git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' | xargs -r black

# Re-add formatted files
git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' | xargs -r git add

print_success "Pre-commit checks completed!"
exit 0
